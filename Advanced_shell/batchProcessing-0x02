#!/bin/bash

POKEMON_LIST=("bulbasaur" "ivysaur" "venusaur" "charmander" "charmeleon")
API_BASE_URL="https://pokeapi.co/api/v2/pokemon/"
OUTPUT_DIR="pokemon_data"
MAX_RETRIES=3
DELAY_SECONDS=0.5 # Delay between successful requests
RETRY_DELAY_SECONDS=2 # Delay after a failed attempt

mkdir -p "${OUTPUT_DIR}"

if ! command -v curl &> /dev/null
then
    echo "Error: 'curl' command is required but not found. Please install it."
    exit 1
fi

for POKEMON_NAME in "${POKEMON_LIST[@]}"; do
    echo "Fetching data for ${POKEMON_NAME}..."
    ATTEMPTS=0
    SUCCESS=false

    OUTPUT_FILE="${OUTPUT_DIR}/${POKEMON_NAME}.json"
    API_URL="${API_BASE_URL}${POKEMON_NAME}"

    while [ ${ATTEMPTS} -lt ${MAX_RETRIES} ]; do
    curl -sS "${API_URL}" -o "${OUTPUT_FILE}"

    if [ $? -eq 0 ]; then
            # Success!
            SUCCESS=true
            echo "Saved data to ${OUTPUT_FILE} ✅"
            break # Exit the while loop
        else
            # Failure: API call or network issue
            echo "Attempt ${ATTEMPTS} failed for ${POKEMON_NAME}. Retrying in ${RETRY_DELAY_SECONDS} seconds..."
            # Clean up the partial/corrupt file
            rm -f "${OUTPUT_FILE}"
            sleep ${RETRY_DELAY_SECONDS}
        fi
    done
    if [ "${SUCCESS}" == "false" ]; then
        echo "‼️ ERROR: Failed to fetch data for ${POKEMON_NAME} after ${MAX_RETRIES} attempts. Skipping."
    fi

    # Delay between requests to be polite to the API
    if [ "${SUCCESS}" == "true" ]; then
        sleep ${DELAY_SECONDS}
    fi
done

echo ""
echo "Batch processing complete."